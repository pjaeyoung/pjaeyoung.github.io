---
title: '20210608'
date: 2021-06-08 22:06:27
category: sccap
thumbnail: { thumbnailSrc }
draft: false
---

- 오늘 우연히 **'스크린샷 감지 후 앱실행'** 성능향상 방법을 찾게 되었다. 😂

  - `react-native-detector` 라이브러리를 아래처럼 직접 수정했다.

  ```kotlin
  // react-native-detector > DetectorModule.kt
  // 기존에 path 넘겨주지 않은 부분을 넘겨주도록 함
  override fun onScreenCaptured(path: String) {
          reactContext
                  .getJSModule(DeviceEventManagerModule.RCTDeviceEventEmitter::class.java)
                  ~~.emit("UIApplicationUserDidTakeScreenshotNotification", null)~~
                  .emit("UIApplicationUserDidTakeScreenshotNotification", path)
  }
  ```

  ```tsx
  // react-native-detector > index.tsx
  // callback에도 path 넘겨줌
  export function addScreenshotListener(callback: Function) {
    if (Platform.OS === 'android') Detector.startScreenshotDetection();
    const eventEmitter = new NativeEventEmitter(Detector);
    eventEmitter.addListener(
      EventsName.UserDidTakeScreenshot,
      ~~() => callback(),~~
      (path) => callback(path),
      {}
    );

    return eventEmitter;
  }
  ```

  - 그리고 우리 앱에서 `addScreenshotListener` 의 callback인 `userDidScreenshot` 에서 곧바로 path를 전달하면 된다.
  - 특이하게 `openApp` 의 첫 번째 `then` 안에서 파일 작업을 하면 로딩 속도가 느린데 아래처럼 두 번째 `then` 에서 하면 빠르게 로드된다. (그래도 여전히 여러 번 스크린샷 할수록 호출 횟수가 증가한다)

  ```tsx
  // backgroundSerivce.ts
  const userDidScreenshot = (path: string): void => {
    // base64 만 허용하는 react-native-share 기능을 사용하기 위한 작업
    Promise.all([
      `${path}`,
      RNFS.readFile(`file://${path}`, 'base64'),
      openApp(packageId),
    ])
      .then(([screenshotPath, screenshotBase64]) => {
        navigate('Sort', { screenshotPath, screenshotBase64 })
      })
      .catch(e => console.warn(e))
  }
  ```

  - 한 가지 아쉬운 점은 아래 warning 메세지가 나온다. 추측상 이미지 경로는 생성되었으나 이미지 파일이 생성된 것은 아니라서 곧장 해당 경로에 접근해도 파일이 없다고 나오는 것 같다. (그래서 `react-native-detector` 가 screenshot path를 전달하지 않은 까닭일지도). 혹은 `openApp` 자체가 문제일지도 모른다. 자세한 건 나중에 알아보자. 지금은 파일시스템에 집중!

  ```tsx
  [Error: ENOENT: /storage/emulated/0/DCIM/Screenshots/.pending-1623761149-Screenshot_20210608-214549_Chrome.jpg: open failed: ENOENT (No such file or directory), open '/storage/emulated/0/DCIM/Screenshots/.pending-1623761149-Screenshot_20210608-214549_Chrome.jpg']
  ```

- 폴더 생성 / 삭제 , 사본이미지 생성/삭제 테스트 완료
  - `react-native-fs` 의 `copyFile` 메서드를 사용해서 사본 이미지 생성하려고 할 때 계속 `EISDIR: illegal operation on a directory` 에러가 나서 애를 먹었다. 알고보니 내 실수.. [stackoverflow](https://stackoverflow.com/questions/58525721/eisdir-illegal-operation-on-a-directory-read-in-react-native-file-system) 에서 `destinationPath` 의 마지막에 파일명도 써줘야 한다는 걸 알았다!
